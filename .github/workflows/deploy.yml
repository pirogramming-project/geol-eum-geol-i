name: Deploy to Naver Cloud

on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ì— pushë  ë•Œ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: pip install fabric paramiko  # Fabric ì„¤ì¹˜

      - name: Deploy with SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "$SSH_PRIVATE_KEY" | tr -d '\r' > github_actions_key
          chmod 600 github_actions_key
          ssh -o StrictHostKeyChecking=no -i github_actions_key root@101.79.11.121 << 'EOF'
            set -e  # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
            echo "ðŸš€ ë°°í¬ ì‹œìž‘!"

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì´ë™
            cd /home/ubuntu/geol-eum-geol-i

            # ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            git pull origin main
            echo "ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ"

            # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
            source venv/bin/activate
            pip install -r requirements.txt
            echo "íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ì™„ë£Œ"

            # DB ë§ˆì´ê·¸ë ˆì´ì…˜
            python manage.py migrate
            echo "DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ"

            # ê¸°ì¡´ collectstatic íŒŒì¼ ì‚­ì œ í›„ ë‹¤ì‹œ ìƒì„±
            rm -rf staticfiles/
            python manage.py collectstatic --noinput
            echo "ì •ì  íŒŒì¼ ìƒì„± ì™„ë£Œ"

            # ì •ì  íŒŒì¼ ê¶Œí•œ ë³€ê²½
            sudo chmod -R 755 /home/ubuntu/geol-eum-geol-i/staticfiles/
            sudo chown -R www-data:www-data /home/ubuntu/geol-eum-geol-i/staticfiles/
            echo "ì •ì  íŒŒì¼ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"

            # Gunicorn & Nginx ìž¬ì‹œìž‘
            sudo systemctl restart gunicorn
            sudo systemctl restart nginx
            sudo systemctl reload nginx
            echo "Gunicorn & Nginx ìž¬ì‹œìž‘ ì™„ë£Œ"

            echo "ìžë™ ë°°í¬ ì™„ë£Œ"
          EOF
