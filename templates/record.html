<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš´ë™ ê¸°ë¡</title>
</head>
<body>
    <h1>ìš´ë™ ê¸°ë¡</h1>

    <button id="startButton">ìš´ë™ ì‹œì‘</button>
    <button id="stopButton" style="display: none;">ìš´ë™ ì¢…ë£Œ</button>

    <p id="timeDisplay">ìš´ë™ ì‹œê°„: 00:00:00</p>
    <p id="distanceDisplay">ì´ë™ ê±°ë¦¬: 0.00 km</p>
    <p id="caloriesDisplay">ì†Œëª¨ ì¹¼ë¡œë¦¬: 0 kcal</p>

    <!-- CSRF í† í°ì„ HTMLì— í¬í•¨ -->
    <input type="hidden" id="csrf_token" value="{{ csrf_token }}">

    <script>
        let start_time = null;
        let end_time = null;
        let path = [];
        let distance = 0.0;
        let watchID = null;
        let interval = null;
        let elapsedTime = 0;
        let lastPosition = null;
        let userWeight = 75; // âœ… ê¸°ë³¸ ì²´ì¤‘ 75kg (ì‚¬ìš©ìë³„ ì²´ì¤‘ ì ìš© ê°€ëŠ¥)

        document.getElementById("startButton").addEventListener("click", function() {
            path = [];
            distance = 0.0;
            elapsedTime = 0;
            lastPosition = null;
            start_time = new Date().toISOString();
            console.log("ìš´ë™ ì‹œì‘ ì‹œê°„:", start_time);

            document.getElementById("startButton").style.display = "none";
            document.getElementById("stopButton").style.display = "inline-block";

            // âœ… ğŸš€ `setInterval()` ì¶”ê°€ (1ì´ˆë§ˆë‹¤ `elapsedTime` ì¦ê°€)
            interval = setInterval(() => {
                elapsedTime++;
                updateTimeDisplay();  // âœ… UI ê°±ì‹  í•¨ìˆ˜ í˜¸ì¶œ
            }, 1000);
            
            // ğŸš€ GPS ìœ„ì¹˜ ì¶”ì  ì‹œì‘
            if (navigator.geolocation) {
                watchID = navigator.geolocation.watchPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        path.push({ lat: latitude, lng: longitude });

                        if (lastPosition) {
                            distance += calculateDistance(lastPosition.lat, lastPosition.lng, latitude, longitude);
                        }
                        lastPosition = { lat: latitude, lng: longitude };

                        updateDistanceDisplay();
                    },
                    (error) => console.error("ìœ„ì¹˜ ì¶”ì  ì˜¤ë¥˜:", error),
                    { enableHighAccuracy: true, maximumAge: 1000 }
                );
            }
        });

        document.getElementById("stopButton").addEventListener("click", function() { 
            if (!start_time) {
                console.error("ğŸš¨ ìš´ë™ ì‹œì‘ ì‹œê°„ì´ ì—†ìŒ!");
                return; 
            }

            end_time = new Date().toISOString();
            console.log("ìš´ë™ ì¢…ë£Œ ì‹œê°„:", end_time);

            if (watchID) navigator.geolocation.clearWatch(watchID);
            clearInterval(interval);

            // ğŸš€ CSRF í† í° ê°€ì ¸ì˜¤ê¸°
            const csrfToken = document.getElementById("csrf_token").value;

            let minutes = elapsedTime / 60;
            let calories = calculateCalories(distance, minutes, userWeight);  // âœ… Djangoì™€ ë™ì¼í•œ ë¡œì§ ì ìš©

            // ğŸš€ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡
            fetch("/record/save_walk_record/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify({
                    start_time: start_time,
                    end_time: end_time,
                    distance: distance.toFixed(2),
                    calories: parseInt(calories),
                    path: path
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log("ìš´ë™ ê¸°ë¡ ì €ì¥ ì™„ë£Œ:", data);
                updateUI(data);
            })
            .catch(error => console.error("ğŸš¨ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:", error));

            // âœ… ìš´ë™ ì¢…ë£Œ í›„ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.getElementById("startButton").style.display = "inline-block";
            document.getElementById("stopButton").style.display = "none";
        });

        // âœ… ìš´ë™ ì‹œê°„ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
        function updateTimeDisplay() {
            let hours = Math.floor(elapsedTime / 3600);
            let minutes = Math.floor((elapsedTime % 3600) / 60);
            let seconds = elapsedTime % 60;

            document.getElementById("timeDisplay").innerText = 
                `ìš´ë™ ì‹œê°„: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateDistanceDisplay() {
            let minutes = elapsedTime / 60;
            let calories = calculateCalories(distance, minutes, userWeight);  // âœ… Djangoì™€ ë™ì¼í•œ ë¡œì§ ì ìš©

            document.getElementById("distanceDisplay").innerText = `ì´ë™ ê±°ë¦¬: ${distance.toFixed(2)} km`;
            document.getElementById("caloriesDisplay").innerText = `ì†Œëª¨ ì¹¼ë¡œë¦¬: ${parseInt(calories)} kcal`;
        }

        // âœ… ìš´ë™ ì¢…ë£Œ í›„ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ì¶”ê°€
        function updateUI(data) {
            document.getElementById("timeDisplay").innerText = `ìš´ë™ ì‹œê°„: ${data.time}`;
            document.getElementById("distanceDisplay").innerText = `ì´ë™ ê±°ë¦¬: ${data.distance} km`;
            document.getElementById("caloriesDisplay").innerText = `ì†Œëª¨ ì¹¼ë¡œë¦¬: ${data.calories} kcal`;
        }

        // ğŸš€ Djangoì™€ ë™ì¼í•œ ì¹¼ë¡œë¦¬ ê³„ì‚° í•¨ìˆ˜
        function calculateCalories(distance, timeInMinutes, weight) {
            let speed = distance / (timeInMinutes / 60);
            let METs;

            if (speed < 5.5) {
                METs = 3.8;
            } else if (speed < 8.0) {
                METs = 4.3;
            } else {
                METs = 7.0;
            }

            return parseInt(METs * weight * (timeInMinutes / 60));  // âœ… ì •ìˆ˜í˜• ë³€í™˜ ì¶”ê°€
        }

        // ğŸš€ ë‘ ì¢Œí‘œ ê°„ ê±°ë¦¬ ê³„ì‚° (Haversine ê³µì‹ ì‚¬ìš©)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }
    </script>
</body>
</html>
