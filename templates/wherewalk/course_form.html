<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/reset.css' %}">
    <link rel="stylesheet" href="{% static 'css/root.css' %}">
    <link rel="stylesheet" href="{% static 'css/wherewalk/courseform.css' %}">
    <title>ì–´ë”” ê±¸ìŒ?</title>
</head>
<body>
    <div class="wrapper">
        <div class="course-form-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="47" height="57" viewBox="0 0 47 57" fill="none">
                <path d="M36.4381 26.8837V40.0532C36.4381 41.8312 34.8251 43.2793 32.8327 43.2793H26.9761V31.3566C26.9761 30.2037 26.0426 29.2702 24.8897 29.2702H21.5498C20.3937 29.2702 19.4635 30.2037 19.4635 31.3566V43.2793H13.6068C11.6227 43.2793 10.0014 41.8312 10.0014 40.0532V26.8837C10.1795 26.7947 23.2174 15.2642 23.2174 15.2642C23.2174 15.2642 36.2552 26.7913 36.4334 26.8837H36.4381ZM40.474 21.4953L24.5612 7.88709C23.7976 7.22408 22.6481 7.22408 21.8927 7.88709L5.96518 21.4953C5.17187 22.1798 5.04816 23.3524 5.6782 24.1672C6.01136 24.6141 6.53582 24.9061 7.10156 24.9605C7.16423 24.9687 7.2368 24.9737 7.29947 24.9737C7.78933 24.9737 8.26598 24.8005 8.63378 24.4838L23.222 12.0067L37.8136 24.4872C38.1847 24.7989 38.6531 24.9721 39.1429 24.9721C39.7894 24.9721 40.393 24.6769 40.7691 24.1738C41.3975 23.3541 41.2721 22.1814 40.4772 21.497L40.474 21.4953Z" fill="#B82132"/>
            </svg> 
            ì–´ë”” ê±¸ìŒ?
        </div>
            <p>ë‚˜ë§Œì˜ ê±·ê¸° ì¥ì†Œë¥¼ ì¶”ì²œí•´ìš”</p>
        <div class="container">
            <p>í‚¤ì›Œë“œ</p>
            <div class="keywords">
                {% for keyword in keywords|slice:":3" %}
                    <button class="keyword passive">{{ keyword.name }}</button>
                {% endfor %}
        
                <button class="keyword passive" id="loadMoreKeywords">
                    <svg xmlns="http://www.w3.org/2000/svg" width="38" height="31" viewBox="0 0 38 31" fill="none">
                        <path d="M23.7281 20.1412L33.6978 11.8304C34.1109 11.4866 34.1668 10.8716 33.8218 10.4588C33.4762 10.045 32.8636 9.9891 32.4502 10.3335L23.104 18.1247L13.7584 10.3335C13.3441 9.98971 12.7312 10.0456 12.3862 10.4588C12.0411 10.8713 12.097 11.4866 12.5102 11.8304L22.4793 20.1412C22.6604 20.2926 22.8824 20.368 23.104 20.368C23.3259 20.368 23.5475 20.2926 23.7281 20.1412Z" fill="#76453B"/>
                    </svg>
                </button>
            </div>
        
            <form method="POST" action="{% url 'submit_course' %}"enctype="multipart/form-data">
                {% csrf_token %}
            
                <!-- ì½”ìŠ¤ ì œëª© ì…ë ¥ -->
                <input type="text" name="title" placeholder="ì½”ìŠ¤ ì œëª©" required>

                <textarea name="description" placeholder="ì„¤ëª…" rows="4" cols="50" required></textarea>
            
                <!-- ì´ ê±°ë¦¬ ì…ë ¥ (km) -->
                <input type="number" name="distance" step="0.01" placeholder="ì´ ê±°ë¦¬ (km)" required>
            
                <!-- ì˜ˆìƒ ì‹œê°„ ì…ë ¥ (ë¶„) -->
                <input type="number" name="time" placeholder="ì˜ˆìƒ ì†Œìš” ì‹œê°„ (ë¶„)" required>
                
                <!-- ìœ„ì¹˜ ì„ íƒ ë²„íŠ¼ -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="text" id="location-name" name="location" placeholder="ìœ„ì¹˜ (ì˜ˆ: ì„œìš¸ ì‹œì²­)" required readonly>
                <button type="button" id="select-location" class="register-btn">ğŸ“ ì§€ë„ì—ì„œ ì„ íƒ</button>
            
                <!-- ì§€ë„ ë¯¸ë¦¬ë³´ê¸° -->
                <div class="map-container">
                    <iframe id="map-preview"
                        src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk&q=37.5665,126.9780&zoom=15"
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            
                <!-- ì‚¬ì§„ ì—…ë¡œë“œ -->
                <input type="file" name="image">
            
                <!-- ì¶”ì²œí•˜ê¸° ë²„íŠ¼ -->
                <button type="submit" class="register-btn">ì¶”ì²œí•˜ê¸°</button>

                <input type="hidden" id="selectedKeywords" name="selected_keywords">
            </form>
        </div>
        
        <!-- êµ¬ê¸€ë§µ íŒì—… -->
        <div class="map-popup" id="map-popup">
            <div class="map-popup-content">
                <div id="map"></div>
                <button class="close-btn" onclick="closeMapPopup()">í™•ì¸</button>
            </div>
        </div>
    </div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk&callback=initMap" async defer></script>
<script>
    let map;
    let marker;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 37.5665, lng: 126.9780 },
            zoom: 13
        });

        map.addListener("click", (event) => {
            placeMarker(event.latLng);
        });
    }

    function placeMarker(location) {
        if (marker) {
            marker.setPosition(location);
        } else {
            marker = new google.maps.Marker({
                position: location,
                map: map
            });
        }
        document.getElementById("latitude").value = location.lat();
        document.getElementById("longitude").value = location.lng();

        // ì„ íƒëœ ì¢Œí‘œë¡œ ì§€ë„ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        document.getElementById("map-preview").src =
            `https://www.google.com/maps/embed/v1/place?key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk&q=${location.lat()},${location.lng()}&zoom=15`;

        // Geocoding APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì£¼ì†Œ ë³€í™˜
        fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${location.lat()},${location.lng()}&key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "OK" && data.results.length > 0) {
                    document.getElementById("location-name").value = data.results[0].formatted_address;
                } else {
                    document.getElementById("location-name").value = "ì„ íƒëœ ìœ„ì¹˜";
                }
            })
            .catch(error => console.error("Error fetching address:", error));
    }

    document.getElementById("select-location").addEventListener("click", function() {
        document.getElementById("map-popup").style.display = "block";
    });

    function closeMapPopup() {
        document.getElementById("map-popup").style.display = "none";
    }

    const MAX_KEYWORDS = 5;
    const loadMoreButton = document.getElementById('loadMoreKeywords');
    const keywordsContainer = document.querySelector('.keywords');

    const moreKeywords = [
        {% for keyword in keywords|slice:"3:" %}
            "{{ keyword.name }}"{% if not forloop.last %}, {% endif %}
        {% endfor %}
    ];

    let isExpanded = false;
    let selectedKeywords = [];

    // í‚¤ì›Œë“œ ë²„íŠ¼ í´ë¦­ ì‹œ active í´ë˜ìŠ¤ë¥¼ í† ê¸€í•˜ì—¬ ì„ íƒ/í•´ì œ ì²˜ë¦¬
    keywordsContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('keyword') && event.target !== loadMoreButton) {
            const activeKeywords = keywordsContainer.querySelectorAll('.keyword.active');

            // ì„ íƒì„ í•´ì œí•˜ëŠ” ê²½ìš° ê·¸ëŒ€ë¡œ í—ˆìš©
            if (event.target.classList.contains('active')) {
                event.target.classList.remove('active');
                selectedKeywords = selectedKeywords.filter(keyword => keyword !== event.target.textContent);
            } else {
                // ì„ íƒëœ í‚¤ì›Œë“œê°€ 5ê°œ ì´ìƒì´ë©´ ì¶”ê°€ ì„ íƒ ë°©ì§€
                if (activeKeywords.length >= MAX_KEYWORDS) {
                    alert(`ìµœëŒ€ ${MAX_KEYWORDS}ê°œì˜ í‚¤ì›Œë“œë§Œ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                event.target.classList.add('active');
                // í‚¤ì›Œë“œ ëª©ë¡ì— ì¶”ê°€
                selectedKeywords.push(event.target.textContent);
            }
        }
    });

    // "ë” ë³´ê¸° â–¼" í´ë¦­ ì‹œ ì¶”ê°€ í‚¤ì›Œë“œ ì‚½ì…
    loadMoreButton.addEventListener('click', function () {
        if (!isExpanded) {
            moreKeywords.forEach(keyword => {
                // ê¸°ì¡´ í‚¤ì›Œë“œ ì¤‘ì— ê°™ì€ ë‚´ìš©ì´ ìˆìœ¼ë©´ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
                const existingKeywords = Array.from(keywordsContainer.querySelectorAll('.keyword')).map(btn => btn.textContent);
                if (!existingKeywords.includes(keyword)) {
                    const newButton = document.createElement('button');
                    newButton.classList.add('keyword');
                    newButton.textContent = keyword;
                    keywordsContainer.insertBefore(newButton, loadMoreButton);
                }
            });
            loadMoreButton.textContent = 'ë‹«ê¸°';
            isExpanded = true;
        } else {
            // ì¶”ê°€ëœ í‚¤ì›Œë“œ ì¤‘ ì„ íƒë˜ì§€ ì•Šì€ í‚¤ì›Œë“œë§Œ ì œê±°
            const addedKeywords = Array.from(keywordsContainer.querySelectorAll('.keyword'))
                .filter(button => button !== loadMoreButton && !button.classList.contains('active') && !button.classList.contains('passive'));

            addedKeywords.forEach(keyword => {
                keyword.remove();
            });

            loadMoreButton.innerHTML = 'ë” ë³´ê¸° â–¼';
            isExpanded = false;
        }
    });

    document.querySelector('form').addEventListener('submit', function(event) {
        document.getElementById('selectedKeywords').value = selectedKeywords.join(',');
    });
</script>

</body>
</html>