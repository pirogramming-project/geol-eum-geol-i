<!DOCTYPE html>
{% load static %}
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'css/reset.css' %}">
    <link rel="stylesheet" href="{% static 'css/root.css' %}">
    <link rel="stylesheet" href="{% static 'css/wherewalk/courseform.css' %}">
    <title>어디 걸음?</title>
</head>
<body>
    <div class="wrapper">
        <div class="courseform-page-header">
            <div class="courseform-page-header-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="47" height="57" viewBox="0 0 47 57" fill="none">
                <path d="M36.4381 26.8837V40.0532C36.4381 41.8312 34.8251 43.2793 32.8327 43.2793H26.9761V31.3566C26.9761 30.2037 26.0426 29.2702 24.8897 29.2702H21.5498C20.3937 29.2702 19.4635 30.2037 19.4635 31.3566V43.2793H13.6068C11.6227 43.2793 10.0014 41.8312 10.0014 40.0532V26.8837C10.1795 26.7947 23.2174 15.2642 23.2174 15.2642C23.2174 15.2642 36.2552 26.7913 36.4334 26.8837H36.4381ZM40.474 21.4953L24.5612 7.88709C23.7976 7.22408 22.6481 7.22408 21.8927 7.88709L5.96518 21.4953C5.17187 22.1798 5.04816 23.3524 5.6782 24.1672C6.01136 24.6141 6.53582 24.9061 7.10156 24.9605C7.16423 24.9687 7.2368 24.9737 7.29947 24.9737C7.78933 24.9737 8.26598 24.8005 8.63378 24.4838L23.222 12.0067L37.8136 24.4872C38.1847 24.7989 38.6531 24.9721 39.1429 24.9721C39.7894 24.9721 40.393 24.6769 40.7691 24.1738C41.3975 23.3541 41.2721 22.1814 40.4772 21.497L40.474 21.4953Z" fill="#B82132"/>
              </svg>
            </div>
            <div class="courseform-title">
              <div class="courseform-title-firstword">어디</div>
              <div class="courseform-title-secondword">걸음?</div>
            </div>
        </div>
        <div class="form-introduction">나만의 걷기 장소를 추천해요</div>
        <div class="container">
            <p class="form-keyword-title">키워드</p>
            <div class="keywords">
                {% for keyword in keywords|slice:":3" %}
                    <button class="keyword passive">{{ keyword.name }}</button>
                {% endfor %}
        
                <button class="keyword passive" id="loadMoreKeywords">
                    <svg xmlns="http://www.w3.org/2000/svg" width="38" height="31" viewBox="0 0 38 31" fill="none">
                        <path d="M23.7281 20.1412L33.6978 11.8304C34.1109 11.4866 34.1668 10.8716 33.8218 10.4588C33.4762 10.045 32.8636 9.9891 32.4502 10.3335L23.104 18.1247L13.7584 10.3335C13.3441 9.98971 12.7312 10.0456 12.3862 10.4588C12.0411 10.8713 12.097 11.4866 12.5102 11.8304L22.4793 20.1412C22.6604 20.2926 22.8824 20.368 23.104 20.368C23.3259 20.368 23.5475 20.2926 23.7281 20.1412Z" fill="#76453B"/>
                    </svg>
                </button>
            </div>
        
            <form method="POST" action="{% url 'submit_course' %}"enctype="multipart/form-data">
                {% csrf_token %}
                <p class="form-keyword-title">코스 제목</p>
                <!-- 코스 제목 입력 -->
                <input class="title-input-form" type="text" name="title" required>
                <p class="form-keyword-title">이미지</p>
                <!-- 사진 업로드 -->
                <div class="image-container">
                    <input type="file" name="image" id="file-upload" class="image-input">
                    <span id="file-name">선택된 파일 없음</span>
                    <label for="file-upload" class="custom-file-btn">등록</label>
                </div>
                <p class="form-keyword-title">장소</p>
                <textarea name="description" rows="4" cols="50" required></textarea>
                <p class="form-keyword-title">거리</p>
                <!-- 총 거리 입력 (km) -->
                <input type="number" name="distance" step="0.01" required>
                <p class="form-keyword-title">예상소요시간</p>
                <!-- 예상 시간 입력 (분) -->
                <input type="number" name="time" required>
                <p class="form-keyword-title">위치(이름)</p>
                <!-- 위치 선택 버튼 -->
                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">
                <input type="text" id="location-name" name="location" required readonly>
                <button type="button" id="select-location" class="register-btn">지도에서 선택</button>
            
                <!-- 지도 미리보기 -->
                <div class="map-container">
                    <iframe id="map-preview"
                        src="https://www.google.com/maps/embed/v1/place?key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk&q=37.5665,126.9780&zoom=15"
                        allowfullscreen
                        loading="lazy">
                    </iframe>
                </div>
            
                <!-- 추천하기 버튼 -->
                <button type="submit" class="register-btn">추천하기</button>

                <input type="hidden" id="selectedKeywords" name="selected_keywords">
            </form>
        </div>
        
        <!-- 구글맵 팝업 -->
        <div class="map-popup" id="map-popup">
            <div class="map-popup-content">
                <div id="map"></div>
                <button class="close-btn" onclick="closeMapPopup()">확인</button>
            </div>
        </div>
    </div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk&callback=initMap" async defer></script>
<script>

    // 파일 선택 후 파일 이름 표시
    document.getElementById("file-upload").addEventListener("change", function(event) {
        const fileName = event.target.files[0] ? event.target.files[0].name : "선택된 파일 없음";
        document.getElementById("file-name").textContent = fileName;
    });
    
    let map;
    let marker;

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { lat: 37.5665, lng: 126.9780 },
            zoom: 13
        });

        map.addListener("click", (event) => {
            placeMarker(event.latLng);
        });
    }

    function placeMarker(location) {
        if (marker) {
            marker.setPosition(location);
        } else {
            marker = new google.maps.Marker({
                position: location,
                map: map
            });
        }
        document.getElementById("latitude").value = location.lat();
        document.getElementById("longitude").value = location.lng();

        // 선택된 좌표로 지도 미리보기 업데이트
        document.getElementById("map-preview").src =
            `https://www.google.com/maps/embed/v1/place?key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk&q=${location.lat()},${location.lng()}&zoom=15`;

        // Geocoding API를 사용하여 주소 변환
        fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${location.lat()},${location.lng()}&key=AIzaSyBee6FEr_x2fj9EqPDmktobzcQ6dPkAouk`)
            .then(response => response.json())
            .then(data => {
                if (data.status === "OK" && data.results.length > 0) {
                    document.getElementById("location-name").value = data.results[0].formatted_address;
                } else {
                    document.getElementById("location-name").value = "선택된 위치";
                }
            })
            .catch(error => console.error("Error fetching address:", error));
    }

    document.getElementById("select-location").addEventListener("click", function() {
        document.getElementById("map-popup").style.display = "block";
    });

    function closeMapPopup() {
        document.getElementById("map-popup").style.display = "none";
    }

    const loadMoreButton = document.getElementById('loadMoreKeywords');
    const keywordsContainer = document.querySelector('.keywords');

    const moreKeywords = [
        {% for keyword in keywords|slice:"3:" %}
            "{{ keyword.name }}"{% if not forloop.last %}, {% endif %}
        {% endfor %}
    ];

    let isExpanded = false;
    let selectedKeywords = [];

    // 키워드 버튼 클릭 시 active 클래스를 토글하여 선택/해제 처리
    keywordsContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('keyword') && event.target !== loadMoreButton) {
            const activeKeywords = keywordsContainer.querySelectorAll('.keyword.active');

            // 선택을 해제하는 경우 그대로 허용
            if (event.target.classList.contains('active')) {
                event.target.classList.remove('active');
                selectedKeywords = selectedKeywords.filter(keyword => keyword !== event.target.textContent);
            } else {
                event.target.classList.add('active');
                // 키워드 목록에 추가
                selectedKeywords.push(event.target.textContent);
            }
        }
    });

    // "더 보기 ▼" 클릭 시 추가 키워드 삽입
    loadMoreButton.addEventListener('click', function () {
        if (!isExpanded) {
            moreKeywords.forEach(keyword => {
                // 기존 키워드 중에 같은 내용이 있으면 추가하지 않음
                const existingKeywords = Array.from(keywordsContainer.querySelectorAll('.keyword')).map(btn => btn.textContent);
                if (!existingKeywords.includes(keyword)) {
                    const newButton = document.createElement('button');
                    newButton.classList.add('keyword');
                    newButton.textContent = keyword;
                    keywordsContainer.insertBefore(newButton, loadMoreButton);
                }
            });
            loadMoreButton.textContent = '닫기';
            isExpanded = true;
        } else {
            // 추가된 키워드 중 선택되지 않은 키워드만 제거
            const addedKeywords = Array.from(keywordsContainer.querySelectorAll('.keyword'))
                .filter(button => button !== loadMoreButton && !button.classList.contains('active') && !button.classList.contains('passive'));

            addedKeywords.forEach(keyword => {
                keyword.remove();
            });

            loadMoreButton.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="38" height="31" viewBox="0 0 38 31" fill="none"><path d="M23.7281 20.1412L33.6978 11.8304C34.1109 11.4866 34.1668 10.8716 33.8218 10.4588C33.4762 10.045 32.8636 9.9891 32.4502 10.3335L23.104 18.1247L13.7584 10.3335C13.3441 9.98971 12.7312 10.0456 12.3862 10.4588C12.0411 10.8713 12.097 11.4866 12.5102 11.8304L22.4793 20.1412C22.6604 20.2926 22.8824 20.368 23.104 20.368C23.3259 20.368 23.5475 20.2926 23.7281 20.1412Z" fill="#76453B"/></svg>';;
            isExpanded = false;
        }
    });

    document.querySelector('form').addEventListener('submit', function(event) {
        document.getElementById('selectedKeywords').value = selectedKeywords.join(',');
    });
</script>

</body>
</html>